import csv
import folium

libraries = []

with open("libraries_2019_2025.csv", encoding="utf-8") as f:
    reader = csv.DictReader(f)
    for row in reader:
        libraries.append({
            "name": row["name"],
            "lat": float(row["lat"]),
            "lon": float(row["lon"]),
            "2019_has_cafeteria": row["2019_has_cafeteria"].strip().lower(),
            "2025_has_cafeteria": row["2025_has_cafeteria"].strip().lower(),
            "url": row.get("url", "#"),
            "etc": row.get("etc", "")
        })

# 2. ì§€ë„ ì´ˆê¸°í™”
m = folium.Map(location=[37.5665, 126.9780], zoom_start=11)

# 3. ë ˆì´ì–´ ê·¸ë£¹ ë§Œë“¤ê¸° 
# overlay=Falseë¡œ ì„¤ì •í•˜ë©´ ë¼ë””ì˜¤ ë²„íŠ¼(í•˜ë‚˜ë§Œ ì„ íƒ ê°€ëŠ¥) í˜•íƒœë¡œ ë°”ë€ë‹ˆë‹¤.
layer_2019 = folium.FeatureGroup(name="ğŸ½ï¸ 2019ë…„ ë„ì„œê´€ êµ¬ë‚´ì‹ë‹¹ í˜„í™©", overlay=False)
layer_2025 = folium.FeatureGroup(name="ğŸ½ï¸ 2025ë…„ ë„ì„œê´€ êµ¬ë‚´ì‹ë‹¹ í˜„í™©", overlay=False)

# ê° ë ˆì´ì–´ì— ë°°ê²½ ì§€ë„ ì¶”ê°€
folium.TileLayer('openstreetmap', name="2019 ë°°ê²½").add_to(layer_2019)
folium.TileLayer('openstreetmap', name="2025 ë°°ê²½").add_to(layer_2025)

# 4. ë°ì´í„° ìˆœíšŒí•˜ë©° ë§ˆì»¤ ìƒì„±
for lib in libraries:
    
    # --- [2019ë…„ ë§ˆì»¤ ìƒì„±] ---
    has_cafe_19 = lib["2019_has_cafeteria"]

    if len(has_cafe_19) > 0:

        icon_19 = "cutlery" if has_cafe_19 == "yes" else "info"
        color_19 = "orange" if has_cafe_19 == "yes" else "gray"

        # ë¹„ê³ (etc) ë‚´ìš©ì´ ìˆì„ ë•Œë§Œ ì¶”ê°€
        etc_text = f"<br><small style='color:gray'>{lib['etc']}</small>" if lib['etc'].strip() else ""
        
        html_19 = f"""
        <div style="font-size: 12px; font-family: 'Noto Sans KR', sans-serif; min-width:150px;">
            <strong style="font-size: 14px; color:#2a5db0;">{lib['name']} (2019)</strong><br>
            ğŸ½ êµ¬ë‚´ì‹ë‹¹: {'<span style="color:blue">ìˆìŒ â­•</span>' if has_cafe_19 == "yes" else '<span style="color:red">ì—†ìŒ âŒ</span>'}<br>
            <a href="{lib['url']}" target="_blank">í™ˆí˜ì´ì§€ ë°”ë¡œê°€ê¸°</a><br>
            {etc_text}
        </div>
        """
        
        folium.Marker(
            location=[lib["lat"], lib["lon"]],
            icon=folium.Icon(icon=icon_19, prefix="fa", color=color_19),
            # íˆ´íŒ(ì„ íƒì‚¬í•­) tooltip=f"{lib['name']} (2019)",
            popup=folium.Popup(html_19, max_width=250)
        ).add_to(layer_2019) # 2019 ë ˆì´ì–´ì— ì¶”ê°€!


    # --- [2025ë…„ ë§ˆì»¤ ìƒì„±] ---
    has_cafe_25 = lib["2025_has_cafeteria"]

    if len(has_cafe_25) > 0:

        icon_25 = "cutlery" if has_cafe_25 == "yes" else "info"
        color_25 = "orange" if has_cafe_25 == "yes" else "gray"
        
        # ë¹„ê³ (etc) ë‚´ìš©ì´ ìˆì„ ë•Œë§Œ ì¶”ê°€
        etc_text = f"<br><small style='color:gray'>{lib['etc']}</small>" if lib['etc'].strip() else ""
        
        html_25 = f"""
        <div style="font-size: 12px; font-family: 'Noto Sans KR', sans-serif; min-width:150px;">
            <strong style="font-size: 14px; color:#2a5db0;">{lib['name']} (2025)</strong><br>
            ğŸ½ êµ¬ë‚´ì‹ë‹¹: {'<span style="color:blue">ìˆìŒ â­•</span>' if has_cafe_25 == "yes" else '<span style="color:red">ì—†ìŒ âŒ</span>'}<br>
            <a href="{lib['url']}" target="_blank">í™ˆí˜ì´ì§€ ë°”ë¡œê°€ê¸°</a><br>
            {etc_text}
        </div>
        """
        
        folium.Marker(
            location=[lib["lat"], lib["lon"]],
            icon=folium.Icon(icon=icon_25, prefix="fa", color=color_25),
            # íˆ´íŒ(ì„ íƒì‚¬í•­) tooltip=f"{lib['name']} (2025)",
            popup=folium.Popup(html_25, max_width=250)
        ).add_to(layer_2025) # 2025 ë ˆì´ì–´ì— ì¶”ê°€!

# 5. â­ ë ˆì´ì–´ë¥¼ ì§€ë„ì— ì¶”ê°€ (ìˆœì„œê°€ ì¤‘ìš”í•©ë‹ˆë‹¤!)
# ë¼ë””ì˜¤ ë²„íŠ¼ ëª©ë¡ì—ì„œ ìœ„ìª½ì— ë°°ì¹˜í•˜ê³  ì‹¶ì€ ìˆœì„œëŒ€ë¡œ ì¶”ê°€í•©ë‹ˆë‹¤.
layer_2019.add_to(m) # 1ìˆœìœ„: 2019
layer_2025.add_to(m) # 2ìˆœìœ„: 2025

# 6. ë ˆì´ì–´ ì»¨íŠ¸ë¡¤ ì¶”ê°€ (ë¼ë””ì˜¤ ë²„íŠ¼ í™œì„±í™”)
folium.LayerControl(collapsed=False).add_to(m)

# 7. â­ ê°œì„ ëœ ìë°”ìŠ¤í¬ë¦½íŠ¸ (ì²« ë¡œë”© ì‹œ 2019 ë ˆì´ì–´ë¥¼ ê°•ì œë¡œ ì„ íƒ)
# setTimeoutì„ ì‚¬ìš©í•˜ì—¬ ì§€ë„ ì»¨íŠ¸ë¡¤ì´ ì™„ì „íˆ ìƒì„±ëœ í›„ì— í´ë¦­í•˜ë„ë¡ ë³´ì¥í•©ë‹ˆë‹¤.
auto_click_script = """
<script>
window.onload = function() {
    setTimeout(function() {
        var radioButtons = document.querySelectorAll('input[type="radio"].leaflet-control-layers-selector');
        if (radioButtons.length > 0) {
            radioButtons[1].click(); // ì²« ë²ˆì§¸ ë¼ë””ì˜¤ ë²„íŠ¼(2019) í´ë¦­
        }
    }, 100); // 0.1ì´ˆ ëŒ€ê¸° í›„ ì‹¤í–‰
};
</script>
"""
m.get_root().html.add_child(folium.Element(auto_click_script))

# ì»¤ìŠ¤í…€ ìŠ¤íƒ€ì¼
style = """
<style>
.leaflet-control-layers { font-size: 12px !important; font-family: 'Noto Sans KR', sans-serif !important; }
</style>
"""
m.get_root().html.add_child(folium.Element(style))

legend_html = """
<div style="
    position: fixed;
    bottom: 20px;
    right: 20px;
    width: 160px;
    background-color: white;
    border:2px solid grey;
    z-index:9999;
    font-size:12px;
    padding: 10px;
">
<b>ğŸ“Œ êµ¬ë‚´ì‹ë‹¹ ë³´ìœ  ì—¬ë¶€</b><br><br>
<span style="color:orange;">ğŸŸ </span> ì‹ë‹¹ ìˆëŠ” ë„ì„œê´€ â­•ï¸<br>
<span style="color:gray;">âš«ï¸</span> ì‹ë‹¹ ì—†ëŠ” ë„ì„œê´€ âŒ
</div>
"""

m.get_root().html.add_child(folium.Element(legend_html))

m.save("libraries_2019_2025_comparison.html")
print("ìˆ˜ì • ì™„ë£Œ: 2019ë…„ì´ ê¸°ë³¸ìœ¼ë¡œ ì„ íƒë˜ëŠ” ì§€ë„ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.")
